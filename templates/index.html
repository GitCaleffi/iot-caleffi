<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Barcode Scanner - Plug & Play</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .barcode-input {
            font-size: 1.2rem;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .barcode-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .scan-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-operational { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .result-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .result-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="main-container p-5">
                    <!-- Header -->
                    <div class="text-center mb-5">
                        <h1 class="display-4 fw-bold text-primary mb-3">
                            <i class="fas fa-qrcode me-3"></i>
                            Commercial Barcode Scanner
                        </h1>
                        <p class="lead text-muted">
                            Plug & Play Barcode Scanning for 1000+ Devices
                            <br>
                            <small>No Device ID Required - Fully Automated</small>
                        </p>
                        <div class="mt-3">
                            <span class="status-indicator status-operational"></span>
                            <span class="text-success fw-bold">System Operational</span>
                        </div>
                    </div>

                    <!-- Main Scanning Interface -->
                    <div class="row">
                        <div class="col-lg-8 mx-auto">
                            <div class="card border-0 shadow-lg">
                                <div class="card-body p-4">
                                    <h3 class="card-title text-center mb-4">
                                        <i class="fas fa-barcode text-primary"></i>
                                        Scan Barcode
                                    </h3>
                                    
                                    <form id="barcodeForm">
                                        <div class="mb-4">
                                            <label for="barcodeInput" class="form-label fw-bold">
                                                Enter or Scan Barcode:
                                            </label>
                                            <input 
                                                type="text" 
                                                class="form-control barcode-input" 
                                                id="barcodeInput" 
                                                placeholder="1234567890123"
                                                pattern="[0-9]{8,14}"
                                                title="Enter 8-14 digit barcode"
                                                required
                                                autofocus
                                            >
                                            <div class="form-text">
                                                Supported formats: EAN-8 (8 digits), UPC-A (12 digits), EAN-13 (13 digits), GTIN-14 (14 digits)
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary scan-btn" id="scanBtn">
                                                <i class="fas fa-paper-plane me-2"></i>
                                                Process Barcode
                                            </button>
                                        </div>
                                    </form>

                                    <!-- Result Display -->
                                    <div id="resultDiv" class="mt-4" style="display: none;">
                                        <div id="resultAlert" class="alert" role="alert">
                                            <div id="resultContent"></div>
                                        </div>
                                    </div>

                                    <!-- Loading Indicator -->
                                    <div id="loadingDiv" class="text-center mt-4" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Processing...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Processing barcode...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Statistics -->
                    <div class="row mt-5">
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                                <h4 id="successfulScans">{{ stats.successful_scans }}</h4>
                                <p class="text-muted mb-0">Successful Scans</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                                <h4 id="failedScans">{{ stats.failed_scans }}</h4>
                                <p class="text-muted mb-0">Failed Scans</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="fas fa-devices text-info fa-2x mb-2"></i>
                                <h4 id="devicesRegistered">{{ stats.devices_registered }}</h4>
                                <p class="text-muted mb-0">Devices Registered</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="fas fa-clock text-secondary fa-2x mb-2"></i>
                                <h6 id="lastScanTime">{{ stats.last_scan_time or 'Never' }}</h6>
                                <p class="text-muted mb-0">Last Scan</p>
                            </div>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h4 class="card-title text-center mb-4">
                                        <i class="fas fa-info-circle text-info"></i>
                                        How It Works
                                    </h4>
                                    <div class="row">
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
                                            <h6>1. Scan Barcode</h6>
                                            <p class="small text-muted">Enter your barcode in the field above</p>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fas fa-cogs fa-3x text-success mb-3"></i>
                                            <h6>2. Auto Registration</h6>
                                            <p class="small text-muted">System automatically generates device ID</p>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-info mb-3"></i>
                                            <h6>3. Cloud Sync</h6>
                                            <p class="small text-muted">Data sent to Azure IoT Hub instantly</p>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                            <h6>4. Confirmation</h6>
                                            <p class="small text-muted">Get instant feedback and tracking</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="text-center mt-5">
                        <p class="text-muted">
                            <i class="fas fa-shield-alt text-success"></i>
                            Secure • Scalable • Plug & Play
                            <br>
                            <small>Ready for commercial deployment with 1000+ devices</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh stats every 30 seconds
        setInterval(updateStats, 30000);

        // Form submission handler
        document.getElementById('barcodeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('barcodeInput').value.trim();
            const scanBtn = document.getElementById('scanBtn');
            const loadingDiv = document.getElementById('loadingDiv');
            const resultDiv = document.getElementById('resultDiv');
            
            if (!barcode) {
                showResult('Please enter a barcode', false);
                return;
            }

            // Show loading
            scanBtn.disabled = true;
            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ barcode: barcode })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult(`
                        <strong>✅ Success!</strong><br>
                        <strong>Barcode:</strong> ${barcode}<br>
                        <strong>Device ID:</strong> ${data.device_id}<br>
                        <strong>Status:</strong> ${data.message}<br>
                        <strong>Azure IoT Hub:</strong> ${data.azure_connection || data.iot_hub_status || 'offline'}
                    `, true);
                    
                    // Clear the input
                    document.getElementById('barcodeInput').value = '';
                    
                    // Update stats
                    updateStats();
                } else {
                    showResult(`<strong>❌ Error:</strong> ${data.message}`, false);
                }
            } catch (error) {
                showResult(`<strong>❌ Network Error:</strong> ${error.message}`, false);
            } finally {
                scanBtn.disabled = false;
                loadingDiv.style.display = 'none';
            }
        });

        function showResult(message, isSuccess) {
            const resultDiv = document.getElementById('resultDiv');
            const resultAlert = document.getElementById('resultAlert');
            const resultContent = document.getElementById('resultContent');
            
            resultAlert.className = isSuccess ? 'alert result-success' : 'alert result-error';
            resultContent.innerHTML = message;
            resultDiv.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('successfulScans').textContent = stats.successful_scans || 0;
                document.getElementById('failedScans').textContent = stats.failed_scans || 0;
                document.getElementById('devicesRegistered').textContent = stats.devices_registered || 0;
                document.getElementById('lastScanTime').textContent = stats.last_scan_time || 'Never';
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        // Auto-focus on barcode input
        document.getElementById('barcodeInput').focus();
        
        // Handle barcode scanner input (auto-submit when Enter is pressed)
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('barcodeForm').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>
